---
title: 服务端面试二:mongodb
date: 2023-11-08 15:43:55
tags:
    - Mongodb
    - 数据库
categories:
    - Mongodb
---

## 问题列表及答案

1. Mongodb的架构
    1. mongodb server
    2. 存储引擎
2. Mongodb支持的存储引擎
    mongodb采用了可插拔的存储引擎API，允许第三方为mongodb开发存储引擎，存储引擎有如下几种：
    * MMAPV1 刚出来的时候用的存储引擎，4.x版本之后不再使用
    * WiredTiger 3.2之后，默认存储引擎编程WiredTiger
    * In-Memory 存储引擎，将数据不再放到磁盘上，存储在内存中
2. Mongodb是如何组织数据的？
    WiredTiger引擎用B+树组织磁盘上的数据
4. 单机Mongodb下，一条查询sql的执行过程
    1. 生成查询计划：根据查询条件和索引信息生成查询计划，查询计划是一个查询执行的路线图
    2. 查询优化：查询优化器根据查询计划和数据库的统计信息选择最佳的执行策略。
    3. 索引扫描：判断查询条件能否用到索引，如果能用到，会进行索引扫描以快速定位到文档
    4. 数据检索：根据查询条件从磁盘中读取对应文档数据。
    5. 结果返回：将对应文档数据返回给应用程序
5. Mongodb的锁了解吗
    MongoDB 允许多个客户端读写相同的数据。为了确保一致性，MongoDB 使用锁定和并发控制来防止客户端同时修改相同的数据。对单个文档的写入要么完整发生，要么根本不发生，并且客户端始终看到一致的数据。
    MongoDB 使用多粒度锁定，允许操作锁定在全局、数据库或集合级别，并允许各个存储引擎在集合级别以下（例如，在 WiredTiger 中的文档级别）实现自己的并发控制。
6. Mongodb的事务了解吗？分布式事务了解吗
    1. 与关系型数据库一样，MongoDB 事务同样具有 ACID 特性。MongoDB 单文档原生支持原子性，也具备事务的特性。
    2. MongoDB 4.0 加入了对多文档事务的支持，但只支持复制集部署模式下的事务，也就是说事务的作用域限制为一个副本集内。MongoDB 
    3. 4.2 引入了分布式事务，增加了对分片集群上多文档事务的支持，并合并了对副本集上多文档事务的现有支持。
    **6.1 mongodb分布式事务的实现原理** 
    mongodb使用两段式提交来实现分布式事务
    1. 准备阶段：分布式事务协调器向所有参与者发送准备请求，参与者收到以后执行，并返回操作结果。如果所有参与者都表示操作成功，那么分布式事务协调器发送提交请求
    2. 提交阶段：参与者执行提交命令，并反馈操作结果，分布式事务协调器根据操作结果判断是否提交事务

    **6.1 mongodb分布式事务如何提高并发性**
    mongodb使用乐观并发控制来提高并发性。简单来说先操作，提交前对数据进行版本控制，提交时校验版本判断是否应该继续执行。

7. Mongodb的聚合了解吗？Mapreduce的应用场景是什么
    应用场景：
    1. 生成复杂的报表
    2. 计算指标和检测KPI
    3. 图像识别
    4. LOT设备管理与监控
8. Mongodb备份与恢复原理
    1. 冷备份：创建数据文件的副本，前提是要停止服务器
    2. 热备份：运行时备份 mongodump与mongorestore
    3. fsync和锁方式备份：fsync强制将缓冲区的数据写入磁盘，锁阻塞所有写入操作，直到备份完成
    4. 从属备份：在从服务器上备份
9. Mongodb主从复制原理，复制集了解吗
    oplog记录了主节点上所有的写操作，从节点定期轮询oplog，以获取最新的写操作。从节点将oplog的写操作应用到自己的数据集中，以保持与主节点的数据同步。如果主节点发生故障，副本集会基于raft协议选出新的主节点
    raft协议：相关角色有领导者，候选者，跟随者。
10. Mongodb的分片了解吗
    分片是一种水平扩展的方式，将数据集分布在多个服务器上。
11. Mongodb实现高可用的手段有哪些？
    1. 副本集和分片机制来实现数据的高可用和水平扩展。副本集是把数据复制到多个节点上，保证数据的冗余和可用性；分片是将数据划分为多个片段，分散在不同节点上，实现数据的水平扩展。复制集是一个可自动处理故障的主备库集群
    3. 监控，如Prometheus
12. Mongodb与mysql如何选择
    1. 数据模型是什么，如果需要灵活的数据模型，选择mongodb
    2. 数据一致性，如果需要强一致性和事务支持，选择MySQL
    3. 处理规模，如果需要处理海量和高并发请求，选择MongoDB
    4. 应用场景，mysql适用于传统的企业业务系统，mongodb适用于实时分析和社交网络
13. Mongodb查询如何优化？慢查询如何定位问题与解决
    慢查询定位：
    1. explain查看查询计划
    2. mongodb查询慢日志

参考：
https://www.zhihu.com/tardis/bd/art/571183984?source_id=1001