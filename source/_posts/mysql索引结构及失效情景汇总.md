---
title: mysql索引结构及失效情景汇总
date: 2023-09-04 10:34:17
tags:
    - Mysql
categories:
    - Mysql
---
## 一：mysql的索引结构

mysql是一个关系型数据库；
mysql的存储引擎最主要的有两个，一个是myisam，一个是innodb，下面我们分别来说明二者的索引结构
1. myisam
    * myisam的索引，结构是B+树，叶子节点保存的是数据记录的地址，也就是说它的索引和数据是分开的，叫非聚簇索引。
    * myisam的主键索引和非主键索引本质上没有区别，叶子节点都保存的是数据记录的地址
2. innodb
    * innodb的索引，结构是带有数据访问指针的B+树
    * 主键索引的叶子结点，保存的是数据记录本身；非主键索引的叶子节点，保存的是主键值
    * 由于innodb的索引，其索引和数据是在一起的，因此被称为聚簇索引
    * 为提升读取性能，innodb的各节点在磁盘中是一个数据页
        1. 每个节点是一个磁盘页，这样方便读入内存
        2. 每当访问某磁盘页，将读取其相邻的磁盘页，这个操作叫做磁盘预读，因此其相邻的磁盘页也能很快的被访问到；
    * 由于非叶子结点不存数据，所以这颗B+树的阶非常高（即非叶子结点可以储存非常多的数据项），故数高很小，一个近百万数据的表，可能其数高只有3.
    
    一个直观的innodb索引例子：
    ![innodbB+树索引](/pic/innocbbjiatree.jpg)
    其中，一个浅蓝色的区域是一个磁盘页，深蓝色的是数据项，P1 P2 P3 是指针

由于mysql的默认引擎是innodb，所以接下来我们的讨论都基于innodb引擎。

## 二：B+树的增删改查

B+树从B树演变而来，与B树的区别是B+树的非叶子节点只保存导航信息，所有数据都保存在叶子结点；
下面是一颗深度为4的三阶B+树

![b+tree](/pic/bjiatree.jpg)

解释:
* 每个节点最多有3个子节点，因此叫做3阶
* 根节点+非叶节点+叶节点，共4层，因此深度为4
* 每个非叶子节点，其节点上都存有

增删改查要点
* B+树的增，需保持B+树的阶，一旦某节点的子节点数量超过3，需要分裂该节点，并查看父节点是否也有相同的问题。
* B+树的删，同样需保持B+树的阶，B+树的子节点，不得小于m/2，小于之后需要合并节点
* B+树的改，不存在节点结构的变化
* B+树的查，时间复杂度为log(n)，具体过程是每次取出一个节点（即读入一个数据页），比较，确定下一步的查询指针，然后继续这个过程。

## 三：innodb的查找策略

1. 主键查询, 查询主键索引即可
2. 查询用到了非主键索引（也叫辅助索引，二级索引），且所需返回的字段在索引中就有，这时只需要查找辅助索引
3. 查询用到了非主键索引，如联合索引，所需返回的字段在索引中不全，这时候需要查询主键索引（也叫回表查询）
4. 如压根没用到索引，需要全表扫描

## 四：innodb的索引失效场景
1. 联合索引不满足最左前缀匹配原则
2. 索引列参与计算，包括使用了一些函数
3. like %在最左边
4. 类型隐式转换，如在varchar类型的字段上，查找时写int型的值
5. 使用or操作
6. 一些比较  <  > != ; isnot null ;not in ; not exists


## 五：优化项
1. 尽量避免使用select * ,而使用select 具体的字段，以期望走覆盖索引